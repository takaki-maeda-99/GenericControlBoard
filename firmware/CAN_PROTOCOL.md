# CANプロトコル仕様書

## 概要

GenericControlBoardのCAN通信プロトコル仕様です。各Teensyボード間でのモーター制御コマンドとフィードバックデータの通信規約を定義します。

## 基本設定

- **CANボーレート**: 1,000,000 bps (1 Mbps)
- **フレーム形式**: 標準フレーム (11bit ID)
- **エンディアン**: リトルエンディアン (モーターコマンド), ビッグエンディアン (DJIモーター)

## モーター制御プロトコル

### CANフレームID構成

```
┌─────────────┬─────────────┐
│   Bit 7-4   │   Bit 3-0   │
│  Board ID   │  Motor ID   │
│   (1-15)    │   (1-8)     │
└─────────────┴─────────────┘
```

**計算式**: `CAN_ID = (BoardID << 4) | MotorID`

ex: BoardID = 1, MotorID = 3 → CAN_ID = 0x013

### モーターコマンドフレーム

各モーターへの制御指令フレーム (8バイト固定)

| Byte | 名称 | データ型 | 説明 |
|------|------|----------|------|
| 0 | Mode | uint8_t | 制御モード (後述) |
| 1 | Opt | uint8_t | オプション/フラグ (将来拡張用, 現状0固定) |
| 2-5 | Value | int32_t | 指令値 (リトルエンディアン, 1000倍スケール) |
| 6 | Seq | uint8_t | シーケンス番号 (0-255巡回) |
| 7 | Timeout | uint8_t | タイムアウト時間 [10ms単位] (0=デフォルト100ms) |

#### 制御モード

| Mode | 名称 | Value単位 | 説明 |
|------|------|-----------|------|
| 0x00 | Disable | - | モーター停止 |
| 0x01 | Speed | rad/s | 速度制御 |
| 0x02 | BoundedAngle | rad | 角度制御 (-π ～ π制限) |
| 0x03 | UnboundedAngle | rad | 角度制御 (多回転対応) |
| 0xFF | Homing | - | ホーミング開始 |

#### Value値の変換

```c
// 送信時: float → int32_t
int32_t intValue = (int32_t)(floatValue * 1000.0f);

// 受信時: int32_t → float  
float floatValue = (float)intValue / 1000.0f;
```

### 使用例

#### 速度制御 (10 rad/s)

```
Board ID: 1, Motor ID: 3
CAN ID: 0x13 (0001_0011)

Data: [01 00 10 27 00 00 05 0A]
      │  │  └─────────┘ │  └─ Timeout: 100ms
      │  │      │       └─ Seq: 5  
      │  │      └─ Value: 10000 (10.0 rad/s)
      │  └─ Opt: 0
      └─ Mode: 0x01 (Speed)
```

#### 角度制御 (π/2 rad)

```
Board ID: 2, Motor ID: 1  
CAN ID: 0x21 (0010_0001)

Data: [03 00 1F 06 00 00 0C 14]
      │  │  └─────────┘ │  └─ Timeout: 200ms
      │  │      │       └─ Seq: 12
      │  │      └─ Value: 1571 (π/2 ≈ 1.571 rad)  
      │  └─ Opt: 0
      └─ Mode: 0x03 (UnboundedAngle)
```

## タイムアウト処理

- **デフォルトタイムアウト**: 100ms
- **タイムアウト時動作**: モーター電流を0に設定して安全停止
- **シーケンス番号**: 重複コマンド検出用 (同一番号は無視)

## ボード構成

| Board ID | 役割 | 制御モーター |
|----------|------|-------------|
| 1 | teensy1 (ステアリング) | 1-4 (ステアリングモーター) |
| 2 | teensy2 (ホイール) | 1-4 (駆動モーター) |  
| 3 | teensy3 (アーム) | 1-3,9 (アームモーター+サーボ) |

## DJIモーター通信

DJIモーターとの通信は専用クラス`DjiMotorCan`で処理されます。

- **受信ID**: 0x201-0x208 (各モーターからのフィードバック)
- **送信ID**: 0x200 (モーター1-4), 0x1FF (モーター5-8)
- **制御周期**: 1kHz (1ms)